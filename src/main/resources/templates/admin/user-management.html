<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý người dùng - UTEScore</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0f172a;
            --secondary-color: #fbbf24;
            --accent-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --dark-color: #0f172a;
            --light-color: #f8fafc;
            --gradient-primary: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #3b82f6 100%);
            --gradient-secondary: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --gradient-accent: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --gradient-success: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --shadow-primary: 0 20px 25px -5px rgba(15, 23, 42, 0.1), 0 10px 10px -5px rgba(15, 23, 42, 0.04);
            --shadow-secondary: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --sidebar-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%);
            min-height: 100vh;
            color: white;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(251, 191, 36, 0.2);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--shadow-primary);
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 900;
            color: white;
            text-decoration: none;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .sidebar-brand i {
            color: var(--secondary-color);
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin-bottom: 0.25rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            color: white;
            background: rgba(251, 191, 36, 0.1);
            border-left-color: var(--secondary-color);
            transform: translateX(5px);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.2);
        }

        .nav-link.active {
            color: white;
            background: rgba(251, 191, 36, 0.2);
            border-left-color: var(--secondary-color);
        }

        .nav-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .nav-section {
            padding: 1rem 1.5rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Top Bar */
        .top-bar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-primary);
            min-width: 100%;
            overflow: visible;
            width: 100%;
            flex-wrap: nowrap;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            flex-shrink: 1;
            min-width: 0;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 900;
            color: white;
            margin: 0;
            background: linear-gradient(135deg, #ffffff 0%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
        }

        .breadcrumb {
            background: none;
            padding: 0;
            margin: 0;
        }

        .breadcrumb-item a {
            color: var(--secondary-color);
            text-decoration: none;
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: nowrap;
            white-space: nowrap;
            min-width: fit-content;
            flex-shrink: 0;
        }

        .notification-dropdown {
            flex-shrink: 0;
            display: inline-flex;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(251, 191, 36, 0.2);
            flex-shrink: 0;
            display: inline-flex;
        }

        .user-menu:hover {
            background: rgba(251, 191, 36, 0.2);
            transform: translateY(-2px);
            box-shadow: var(--shadow-secondary);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Content Area */
        .content-area {
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow-secondary);
            margin-bottom: 2rem;
        }

        .page-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-primary);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-secondary);
            color: white;
            background: var(--gradient-primary);
        }

        /* Filters */
        .filters-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control, .form-select {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            background-color: #ffffff;
            color: #1f2937;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(251, 191, 36, 0.25);
            background-color: #ffffff;
            color: #1f2937;
            outline: none;
            transform: translateY(-2px);
        }

        .form-control::placeholder {
            color: #9ca3af !important;
            opacity: 1;
        }

        .form-control:focus::placeholder {
            color: #9ca3af !important;
        }

        .form-select {
            background-color: #ffffff !important;
            color: #1f2937 !important;
        }

        .form-select option {
            background: #ffffff;
            color: #1f2937;
        }

        .form-select option:checked {
            background: var(--secondary-color);
            color: var(--dark-color);
        }

        .btn-filter {
            background: var(--accent-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-filter:hover {
            background: #059669;
            transform: translateY(-2px);
            color: white;
        }

        /* Users Table */
        .users-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .card-header {
            background: var(--gradient-primary);
            color: white;
            padding: 1.5rem 2rem;
            border: none;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: #f8fafc;
            border: none;
            font-weight: 600;
            color: var(--dark-color);
            padding: 1rem 1.5rem;
        }

        .table tbody td {
            padding: 1rem 1.5rem;
            border-color: #f3f4f6;
            vertical-align: middle;
        }

        .user-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .user-info-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-details h6 {
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }

        .user-details p {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }

        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-color);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .role-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-admin {
            background: rgba(30, 58, 138, 0.1);
            color: var(--primary-color);
        }

        .role-staff {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
        }

        .role-customer {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-outline-primary {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-outline-success {
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            background: transparent;
        }

        .btn-outline-success:hover {
            background: var(--accent-color);
            color: white;
        }

        .btn-outline-danger {
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            background: transparent;
        }

        .btn-outline-danger:hover {
            background: var(--danger-color);
            color: white;
        }

        /* Pagination */
        .pagination {
            margin: 0;
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .page-link {
            border: none;
            color: var(--primary-color);
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .page-link:hover {
            background: var(--primary-color);
            color: white;
        }

        .page-item.active .page-link {
            background: var(--primary-color);
            color: white;
        }

        /* Modal */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1.5rem;
            color: #333;
        }

        .modal-body .form-label {
            color: #333 !important;
            font-weight: 600;
        }

        .modal-body .form-control {
            color: #333 !important;
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid #ddd !important;
        }

        .modal-body .form-control::placeholder {
            color: #666 !important;
        }

        .modal-body .form-select {
            color: #333 !important;
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid #ddd !important;
        }

        .modal-body .btn {
            color: white !important;
        }

        .modal-body .btn-primary {
            background: var(--gradient-primary) !important;
            border: none !important;
        }

        .modal-body .btn-secondary {
            background: #6c757d !important;
            border: none !important;
        }

        .modal-dialog {
            max-width: 800px;
            margin: 1.75rem auto;
        }

        .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: 15px 15px 0 0;
            border: none;
        }

        .modal-title {
            font-weight: 600;
        }

        .btn-close {
            filter: invert(1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .page-header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: auto;
            }
        }

        /* Toggle Button */
        .sidebar-toggle {
            display: none;
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            margin-right: 1rem;
        }

        @media (max-width: 768px) {
            .sidebar-toggle {
                display: block;
            }
        }

        /* Fix notification dropdown z-index */
        .notification-dropdown {
            z-index: 9999 !important;
            position: absolute !important;
            top: 100% !important;
            right: 0 !important;
            margin-top: 0.5rem !important;
        }

        .notification-dropdown .dropdown-menu {
            z-index: 9999 !important;
            position: absolute !important;
            transform: none !important;
            top: 0 !important;
            left: 0 !important;
            right: auto !important;
            bottom: auto !important;
        }

        /* Ensure top-bar has proper z-index */
        .top-bar {
            z-index: 1000 !important;
            position: relative !important;
        }

        /* Ensure main content doesn't overlap dropdowns */
        .main-content {
            z-index: 1 !important;
            position: relative !important;
        }

        .btn-outline-primary:hover, .btn-outline-success:hover, .btn-outline-danger:hover {
            color: white !important;
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }

        .dropdown-menu {
            background: rgba(15, 23, 42, 0.95) !important;
            border: 1px solid rgba(251, 191, 36, 0.2) !important;
            backdrop-filter: blur(20px);
        }

        .dropdown-item {
            color: white !important;
        }

        .dropdown-item:hover {
            background: rgba(251, 191, 36, 0.2) !important;
            color: white !important;
        }

        .dropdown-header {
            color: var(--secondary-color) !important;
        }

        .badge {
            color: white !important;
        }

        /* Responsive improvements for notification */
        @media (max-width: 768px) {
            .top-bar-right {
                gap: 0.5rem;
            }
            
            .notification-dropdown .btn {
                padding: 0.5rem;
            }
            
            .user-menu {
                padding: 0.4rem 0.8rem;
                gap: 0.5rem;
            }
            
            .user-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-brand">
                <i class="fas fa-cog"></i>
                UTEScore
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">Tổng quan</div>
            <div class="nav-item">
                <a href="/admin/dashboard" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            
            <div class="nav-section">Quản lý</div>
            <div class="nav-item">
                <a href="/admin/fields" class="nav-link">
                    <i class="fas fa-cog"></i>
                    Quản lý sân
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin/user-management" class="nav-link active">
                    <i class="fas fa-users"></i>
                    Quản lý người dùng
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin/live-cameras" class="nav-link">
                    <i class="fas fa-video"></i>
                    Xem camera sân
                </a>
            </div>
            
            <div class="nav-section">Tài chính</div>
            <div class="nav-item">
                <a href="/admin/payment-management" class="nav-link">
                    <i class="fas fa-credit-card"></i>
                    Quản lý thanh toán
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin/refund-management" class="nav-link">
                    <i class="fas fa-undo"></i>
                    Duyệt hoàn tiền
                </a>
            </div>
            
            <div class="nav-section">Hệ thống</div>
            <div class="nav-item">
                <a href="/admin/system-config" class="nav-link">
                    <i class="fas fa-cogs"></i>
                    Cấu hình
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div>
                    <h1 class="page-title">Quản lý người dùng</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin/dashboard">Trang chủ</a></li>
                            <li class="breadcrumb-item"><a href="#">Quản lý</a></li>
                            <li class="breadcrumb-item active">Người dùng</li>
                        </ol>
                    </nav>
                </div>
            </div>
            
            <div class="top-bar-right">
                <!-- Notification Button -->
                <div class="dropdown me-3">
                    <button class="btn btn-light position-relative" type="button" data-bs-toggle="dropdown" style="width: 45px; height: 45px; border-radius: 8px; display: flex; align-items: center; justify-content: center; padding: 0;">
                        <i class="fas fa-bell text-warning"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.65rem;">3</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" style="min-width: 350px; margin-top: 0.5rem;">
                        <li><h6 class="dropdown-header">Thông báo</h6></li>
                        <li><a class="dropdown-item" href="#">Đơn đặt sân mới #1234</a></li>
                        <li><a class="dropdown-item" href="#">Thanh toán thành công #5678</a></li>
                        <li><a class="dropdown-item" href="#">Yêu cầu hoàn tiền #9012</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-center" href="#">Xem tất cả thông báo</a></li>
                    </ul>
                </div>
                
                <!-- User Menu -->
                <div class="user-menu" data-bs-toggle="dropdown">
                    <div class="user-avatar">AD</div>
                    <div class="user-info">
                        <div class="user-name">Admin User</div>
                        <div class="user-role">Quản trị viên</div>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <ul class="dropdown-menu dropdown-menu-end" style="min-width: 200px;">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Hồ sơ</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Cài đặt</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/admin/login"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                </ul>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <div>
                        <h2 class="header-title">Quản lý tài khoản người dùng</h2>
                        <p class="header-subtitle">Quản lý, phân quyền và theo dõi hoạt động của người dùng hệ thống</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="fas fa-user-plus me-2"></i>
                            Thêm người dùng
                        </button>
                        <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#recoverAccountModal">
                            <i class="fas fa-undo me-2"></i>
                            Khôi phục tài khoản
                        </button>
                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
                            <i class="fas fa-key me-2"></i>
                            Reset mật khẩu
                        </button>
                        <button class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>
                            Xuất Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-card">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Tìm kiếm</label>
                        <input type="text" class="form-control" placeholder="Tên, email, số điện thoại...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Vai trò</label>
                        <select class="form-select">
                            <option value="">Tất cả vai trò</option>
                            <option value="admin">Admin</option>
                            <option value="staff">Nhân viên</option>
                            <option value="customer">Khách hàng</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Trạng thái</label>
                        <select class="form-select">
                            <option value="">Tất cả trạng thái</option>
                            <option value="active">Hoạt động</option>
                            <option value="inactive">Không hoạt động</option>
                            <option value="pending">Chờ duyệt</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Ngày tạo</label>
                        <input type="date" class="form-control">
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-filter">
                            <i class="fas fa-search me-2"></i>
                            Lọc
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="users-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-users me-2"></i>
                        Danh sách người dùng (127 người)
                    </h3>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Người dùng</th>
                                <th>Vai trò</th>
                                <th>Trạng thái</th>
                                <th>Đăng ký</th>
                                <th>Hoạt động cuối</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="user-info-cell">
                                        <div class="user-avatar-sm">AD</div>
                                        <div class="user-details">
                                            <h6>Admin User</h6>
                                            <p>admin@utescore.com</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="role-badge role-admin">Admin</span>
                                </td>
                                <td>
                                    <span class="status-badge status-active">Hoạt động</span>
                                </td>
                                <td>15/01/2024</td>
                                <td>2 phút trước</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="user-info-cell">
                                        <div class="user-avatar-sm">NV</div>
                                        <div class="user-details">
                                            <h6>Nguyễn Văn Nhân viên</h6>
                                            <p>staff@utescore.com</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="role-badge role-staff">Nhân viên</span>
                                </td>
                                <td>
                                    <span class="status-badge status-active">Hoạt động</span>
                                </td>
                                <td>10/01/2024</td>
                                <td>1 giờ trước</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="user-info-cell">
                                        <div class="user-avatar-sm">KH</div>
                                        <div class="user-details">
                                            <h6>Trần Thị Khách hàng</h6>
                                            <p>customer@example.com</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="role-badge role-customer">Khách hàng</span>
                                </td>
                                <td>
                                    <span class="status-badge status-active">Hoạt động</span>
                                </td>
                                <td>08/01/2024</td>
                                <td>3 giờ trước</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-ban"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="user-info-cell">
                                        <div class="user-avatar-sm">LQ</div>
                                        <div class="user-details">
                                            <h6>Lê Văn Quyền</h6>
                                            <p>quyen@example.com</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="role-badge role-customer">Khách hàng</span>
                                </td>
                                <td>
                                    <span class="status-badge status-pending">Chờ duyệt</span>
                                </td>
                                <td>14/01/2024</td>
                                <td>1 ngày trước</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="user-info-cell">
                                        <div class="user-avatar-sm">PH</div>
                                        <div class="user-details">
                                            <h6>Phạm Văn Hùng</h6>
                                            <p>hung@example.com</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="role-badge role-customer">Khách hàng</span>
                                </td>
                                <td>
                                    <span class="status-badge status-inactive">Không hoạt động</span>
                                </td>
                                <td>05/01/2024</td>
                                <td>5 ngày trước</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-unlock"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav class="pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">2</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">3</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">4</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">5</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>
                        Thêm người dùng mới
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Họ</label>
                                    <input type="text" class="form-control" id="lastName" placeholder="Nhập họ" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tên</label>
                                    <input type="text" class="form-control" id="firstName" placeholder="Nhập tên" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" placeholder="example@company.com" required>
                            <div class="form-text">Email sẽ được sử dụng để đăng nhập và nhận thông báo</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control" id="phone" placeholder="0123456789" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Vai trò</label>
                                    <select class="form-select" id="role" required>
                                        <option value="">Chọn vai trò</option>
                                        <!-- Roles will be loaded dynamically from database -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Trạng thái</label>
                                    <select class="form-select" id="status" required>
                                        <option value="active">Hoạt động</option>
                                        <option value="inactive">Không hoạt động</option>
                                        <option value="pending">Chờ duyệt</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Sân phụ trách (nếu có)</label>
                            <select class="form-select" id="assignedField">
                                <option value="">Không phụ trách sân</option>
                                <option value="A1">Sân A1</option>
                                <option value="A2">Sân A2</option>
                                <option value="B1">Sân B1</option>
                                <option value="B2">Sân B2</option>
                                <option value="C1">Sân C1</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Mật khẩu</label>
                                    <input type="password" class="form-control" id="password" placeholder="Tối thiểu 8 ký tự" required minlength="8">
                                    <div class="form-text">Mật khẩu phải có ít nhất 8 ký tự</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Xác nhận mật khẩu</label>
                                    <input type="password" class="form-control" id="confirmPassword" placeholder="Nhập lại mật khẩu" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendEmail">
                                <label class="form-check-label" for="sendEmail">
                                    Gửi thông tin tài khoản qua email
                                </label>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Lưu ý:</strong> Hệ thống sẽ kiểm tra email trùng lặp trước khi tạo tài khoản.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" form="addUserForm" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Thêm người dùng
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit me-2"></i>
                        Chỉnh sửa người dùng
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Họ</label>
                                    <input type="text" class="form-control" id="editLastName" placeholder="Nhập họ" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tên</label>
                                    <input type="text" class="form-control" id="editFirstName" placeholder="Nhập tên" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" placeholder="example@company.com" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control" id="editPhone" placeholder="0123456789" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Vai trò</label>
                                    <select class="form-select" id="editRole" required>
                                        <option value="">Chọn vai trò</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Trạng thái</label>
                                    <select class="form-select" id="editStatus" required>
                                        <option value="1">Hoạt động</option>
                                        <option value="0">Bị khóa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" id="saveEditBtn" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recover Account Modal -->
    <div class="modal fade" id="recoverAccountModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-undo me-2"></i>
                        Khôi phục tài khoản bị xóa mềm
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Tìm kiếm và khôi phục các tài khoản đã bị xóa mềm trong hệ thống
                    </div>
                    
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Tìm kiếm tài khoản</label>
                            <input type="text" class="form-control" placeholder="Email, số điện thoại hoặc tên người dùng">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Khoảng thời gian xóa</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="date" class="form-control" placeholder="Từ ngày">
                                </div>
                                <div class="col-md-6">
                                    <input type="date" class="form-control" placeholder="Đến ngày">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Lý do khôi phục</label>
                            <textarea class="form-control" rows="3" placeholder="Mô tả lý do khôi phục tài khoản này..."></textarea>
                        </div>
                    </form>
                    
                    <!-- Deleted Accounts List -->
                    <div class="mt-4">
                        <h6>Danh sách tài khoản đã xóa:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="deletedAccountsTable">
                                <thead>
                                    <tr>
                                        <th>Tài khoản</th>
                                        <th>Email</th>
                                        <th>Loại</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="deletedAccountsBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Không có dữ liệu</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success">
                        <i class="fas fa-search me-2"></i>
                        Tìm kiếm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>
                        Reset mật khẩu người dùng
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Thao tác này sẽ reset mật khẩu và gửi mật khẩu mới qua email/SMS
                    </div>
                    
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Chọn nhân viên</label>
                            <select class="form-select" id="resetPasswordUser" required>
                                <option value="">-- Chọn nhân viên --</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Phương thức gửi mật khẩu mới</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="resetMethod" id="emailReset" value="email" checked>
                                <label class="form-check-label" for="emailReset">
                                    <i class="fas fa-envelope me-2"></i>Gửi qua Email
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="resetMethod" id="smsReset" value="sms">
                                <label class="form-check-label" for="smsReset">
                                    <i class="fas fa-sms me-2"></i>Gửi qua SMS
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Mật khẩu mới</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="newPassword" placeholder="Để trống để tự động tạo">
                                <button class="btn btn-outline-secondary" type="button" onclick="generatePassword()">
                                    <i class="fas fa-random"></i>
                                </button>
                            </div>
                            <div class="form-text">Để trống để hệ thống tự động tạo mật khẩu ngẫu nhiên</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Lý do reset</label>
                            <select class="form-select" required>
                                <option value="">Chọn lý do</option>
                                <option value="forgot">Khách hàng quên mật khẩu</option>
                                <option value="security">Vấn đề bảo mật</option>
                                <option value="admin">Yêu cầu từ admin</option>
                                <option value="other">Khác</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea class="form-control" rows="2" placeholder="Ghi chú thêm (tùy chọn)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-warning" id="confirmResetPassword">
                        <i class="fas fa-key me-2"></i>
                        Reset mật khẩu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Account Recovery Modal -->
    <div class="modal fade" id="recoverAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-undo me-2"></i>
                        Khôi phục tài khoản
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recoverAccountForm">
                        <div class="mb-3">
                            <label class="form-label">Người dùng</label>
                            <input type="text" class="form-control" id="recoverUser" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="recoverEmail" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Trạng thái hiện tại</label>
                            <input type="text" class="form-control" id="currentAccountStatus" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Lý do khôi phục</label>
                            <textarea class="form-control" rows="3" placeholder="Mô tả lý do khôi phục tài khoản..." required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyUser" checked>
                                <label class="form-check-label" for="notifyUser">
                                    Thông báo cho người dùng qua email
                                </label>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Lưu ý:</strong> Tài khoản sẽ được khôi phục về trạng thái "Hoạt động" và người dùng có thể đăng nhập lại.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" id="confirmRecoverAccount">
                        <i class="fas fa-undo me-2"></i>
                        Khôi phục tài khoản
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Lock Modal -->
    <div class="modal fade" id="lockAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-lock me-2"></i>
                        Tạm khóa tài khoản
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="lockAccountForm">
                        <div class="mb-3">
                            <label class="form-label">Người dùng</label>
                            <input type="text" class="form-control" id="lockUser" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="lockEmail" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Trạng thái hiện tại</label>
                            <input type="text" class="form-control" id="currentLockStatus" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Lý do khóa tài khoản</label>
                            <select class="form-select" required>
                                <option value="">Chọn lý do</option>
                                <option value="vacation">Nghỉ phép</option>
                                <option value="violation">Vi phạm quy định</option>
                                <option value="investigation">Đang điều tra</option>
                                <option value="maintenance">Bảo trì hệ thống</option>
                                <option value="other">Lý do khác</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Mô tả chi tiết</label>
                            <textarea class="form-control" rows="3" placeholder="Mô tả chi tiết lý do khóa tài khoản..." required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Thời gian khóa (tùy chọn)</label>
                            <input type="datetime-local" class="form-control" id="lockUntil">
                            <div class="form-text">Để trống nếu khóa vô thời hạn</div>
                        </div>
                        
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Cảnh báo:</strong> Người dùng sẽ không thể đăng nhập vào hệ thống cho đến khi tài khoản được khôi phục.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="confirmLockAccount">
                        <i class="fas fa-lock me-2"></i>
                        Khóa tài khoản
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sidebar toggle for mobile
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('show');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !toggle.contains(e.target)) {
                sidebar.classList.remove('show');
            }
        });

        // Load users data from backend
        let allUsers = [];
        let filteredUsers = [];

        // Load all users on page load
        async function loadUsers() {
            try {
                const response = await fetch('/admin/users/list');
                const data = await response.json();
                console.log('Loaded users data:', data);
                console.log('Total users:', data.length);
                
                allUsers = data;
                filteredUsers = data;
                renderUsers(data);
                populateResetPasswordDropdown(data);
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        // Populate reset password dropdown - ONLY employees
        function populateResetPasswordDropdown(users) {
            const select = document.getElementById('resetPasswordUser');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Chọn nhân viên --</option>';
            
            // Only add employees to the dropdown
            users.forEach(user => {
                if (user.userType === 'employee') {
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = `${user.fullName} (${user.email})`;
                    option.dataset.userId = user.id;
                    option.dataset.userName = user.fullName;
                    option.dataset.userEmail = user.email;
                    select.appendChild(option);
                }
            });
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.querySelector('table tbody');
            if (!tbody) return;

            // Update user count
            const userCountElement = document.querySelector('.card-title');
            if (userCountElement) {
                userCountElement.innerHTML = `<i class="fas fa-users me-2"></i>Danh sách người dùng (${users.length} người)`;
            }

            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = createUserRow(user);
                tbody.appendChild(row);
            });
        }

        // Create user row
        function createUserRow(user) {
            const tr = document.createElement('tr');
            
            // Log the user object to debug
            console.log('Creating row for user:', user);
            
            // Now using DTO with consistent property names
            const isCustomer = user.userType === 'customer';
            const userId = user.id;
            const userName = user.fullName || 'N/A';
            const userEmail = user.email || '';
            const userPhone = user.phone || '';
            const userRole = user.roleName || 'N/A';
            const userStatus = user.status || 'Active';
            
            // Handle date
            let createdAt = new Date();
            if (user.createdAt) {
                createdAt = new Date(user.createdAt);
            }
            
            // Get first letters for avatar
            const initials = userName !== 'N/A' ? 
                userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'NA';
            
            // Format date
            const dateStr = createdAt.toLocaleDateString('vi-VN');
            
            // Escape special characters for onclick
            const safeUserName = userName.replace(/'/g, "\\'");
            const safeUserEmail = userEmail.replace(/'/g, "\\'");
            
            tr.innerHTML = `
                <td>
                    <div class="user-info-cell">
                        <div class="user-avatar-sm">${initials}</div>
                        <div class="user-details">
                            <h6>${userName}</h6>
                            <p>${userEmail}</p>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="role-badge role-${isCustomer ? 'customer' : 'staff'}">${userRole}</span>
                </td>
                <td>
                    <span class="status-badge status-${getStatusClass(userStatus)}">${getStatusText(userStatus)}</span>
                </td>
                <td>${dateStr}</td>
                <td>Vừa xong</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-outline-primary btn-sm" onclick="editUser(${userId}, ${isCustomer})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="resetUserPassword('${safeUserName}', '${safeUserEmail}')">
                            <i class="fas fa-key"></i>
                        </button>
                        ${isCustomer ? 
                            `<button class="btn btn-outline-danger btn-sm" onclick="recoverCustomerAccount(${userId})">
                                <i class="fas fa-unlock"></i>
                            </button>` :
                            `<button class="btn btn-outline-danger btn-sm" onclick="lockEmployeeAccount(${userId})">
                                <i class="fas fa-ban"></i>
                            </button>`
                        }
                    </div>
                </td>
            `;
            
            return tr;
        }

        function getStatusClass(status) {
            const statusLower = String(status).toLowerCase();
            // Handle database values: 1 = active, 0 = inactive
            if (statusLower === '1' || statusLower === 'active' || statusLower.includes('hoạt động')) return 'active';
            if (statusLower === '0' || statusLower === 'inactive' || statusLower.includes('không hoạt động')) return 'inactive';
            if (statusLower.includes('pending') || statusLower.includes('chờ duyệt')) return 'pending';
            return 'active';
        }

        function getStatusText(status) {
            const statusLower = String(status).toLowerCase();
            // Handle database values: 1 = active, 0 = blocked
            if (statusLower === '1') return 'Hoạt động';
            if (statusLower === '0') return 'Bị khóa';
            const statusMap = {
                'active': 'Hoạt động',
                'inactive': 'Bị khóa',
                'locked': 'Bị khóa',
                'pending': 'Chờ duyệt'
            };
            return statusMap[statusLower] || status;
        }

        // Filter functionality
        document.querySelector('.btn-filter').addEventListener('click', function() {
            filterUsers();
        });

        // User actions
        document.querySelectorAll('.btn-outline-primary').forEach(btn => {
            btn.addEventListener('click', function() {
                // Edit user functionality
                console.log('Edit user clicked');
            });
        });

        document.querySelectorAll('.btn-outline-success').forEach(btn => {
            btn.addEventListener('click', function() {
                // Activate/Approve user functionality
                console.log('Activate/Approve user clicked');
            });
        });

        document.querySelectorAll('.btn-outline-danger').forEach(btn => {
            btn.addEventListener('click', function() {
                // Deactivate/Delete user functionality
                if (confirm('Bạn có chắc chắn muốn thực hiện hành động này?')) {
                    console.log('Deactivate/Delete user clicked');
                }
            });
        });

        // Enhanced Add User functionality
        const addUserForm = document.getElementById('addUserForm');
        if (addUserForm) {
            addUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();
                console.log('✅ Form submitted!');
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const email = document.getElementById('email').value;
            
            // Validate password match
            if (password !== confirmPassword) {
                alert('Mật khẩu và xác nhận mật khẩu không khớp!');
                return;
            }
            
            const submitBtn = document.querySelector('#addUserModal .btn-primary');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tạo tài khoản...';
            submitBtn.disabled = true;
            
                try {
                    // Prepare data
                    const lastName = document.getElementById('lastName').value;
                    const firstName = document.getElementById('firstName').value;
                    const fullName = `${lastName} ${firstName}`;
                    const phone = document.getElementById('phone').value;
                    const roleId = parseInt(document.getElementById('role').value);
                    const status = document.getElementById('status').value;
                    
                    console.log('📝 User data:', { fullName, email, phone, roleId, status });
                    
                    // Get sendEmail checkbox value
                    const sendEmail = document.getElementById('sendEmail').checked;
                    
                    const userData = {
                        fullName: fullName,
                        email: email,
                        phone: phone,
                        roleId: roleId,
                        status: status,
                        password: password,  // Add password to request
                        sendEmail: sendEmail  // Add sendEmail flag
                    };
                    
                    console.log('📤 Sending to backend:', userData);
                    
                    // Send to backend
                    const response = await fetch('/admin/employees/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    const result = await response.text();
                    
                    if (result === 'success') {
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                        document.getElementById('addUserForm').reset();
                
                const sendEmail = document.getElementById('sendEmail').checked;
                if (sendEmail) {
                    alert('Tài khoản đã được tạo thành công! Thông tin đăng nhập đã được gửi qua email.');
                } else {
                    alert('Tài khoản đã được tạo thành công!');
                }
                
                        // Reload users list
                        await loadUsers();
                    } else {
                        alert('Lỗi: ' + result);
                    }
                    
                } catch (error) {
                    console.error('Error adding user:', error);
                    alert('Có lỗi xảy ra khi tạo tài khoản: ' + error.message);
                } finally {
                    submitBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Thêm người dùng';
                    submitBtn.disabled = false;
                }
            });
        } else {
            console.error('Add User Form not found');
        }

        // Generate random password function
        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('newPassword').value = password;
        }

        // Reset Password functionality - open modal to select user
        function resetUserPassword(userName, userEmail) {
            // Open the modal
            const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
            modal.show();
            
            // Auto-select the user in the dropdown
            setTimeout(() => {
                const select = document.getElementById('resetPasswordUser');
                if (select) {
                    // Find and select the user
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === userEmail) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                }
            }, 300);
        }

        // Get the confirm button
        const confirmResetPasswordBtn = document.getElementById('confirmResetPassword');
        if (confirmResetPasswordBtn) {
            confirmResetPasswordBtn.addEventListener('click', async function() {
            const btn = this;
                const emailSelect = document.getElementById('resetPasswordUser');
                
                // Validate
                if (!emailSelect || !emailSelect.value) {
                    alert('Vui lòng chọn người dùng cần reset mật khẩu!');
                    return;
                }
                
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
            btn.disabled = true;
            
                try {
                    const selectedOption = emailSelect.options[emailSelect.selectedIndex];
                    const email = selectedOption.value;
                    const userName = selectedOption.dataset.userName || 'người dùng';
                    
                    console.log('=== RESET PASSWORD ATTEMPT ===');
                    console.log('Selected user:', userName);
                    console.log('Email from dropdown:', email);
                    console.log('Full option data:', selectedOption.dataset);
                    
                    const response = await fetch(`/admin/users/${encodeURIComponent(email)}/reset-password`, {
                        method: 'POST'
                    });
                    
                    // Check if response is OK
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('HTTP Error:', response.status, errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    const result = await response.json();
                    console.log('Reset password response:', result);
                    
                    if (result.success) {
                        // Show simple success message - just that email was sent
                        alert('✅ Đã gửi thông tin mật khẩu mới đến email: ' + email);
                        
                        // Close modal and reset form
                bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
                        document.getElementById('resetPasswordUser').value = '';
                        document.getElementById('newPassword').value = '';
                        
                        btn.innerHTML = '<i class="fas fa-key me-2"></i>Reset mật khẩu';
                        btn.disabled = false;
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    console.error('Error resetting password:', error);
                    alert('Lỗi: ' + error.message);
                    btn.innerHTML = '<i class="fas fa-key me-2"></i>Reset mật khẩu';
                    btn.disabled = false;
                }
            });
        }

        // Account Recovery functionality
        function recoverUserAccount(userName, userEmail, currentStatus) {
            document.getElementById('recoverUser').value = userName;
            document.getElementById('recoverEmail').value = userEmail;
            document.getElementById('currentAccountStatus').value = getStatusText(currentStatus);
            
            const modal = new bootstrap.Modal(document.getElementById('recoverAccountModal'));
            modal.show();
        }

        document.getElementById('confirmRecoverAccount').addEventListener('click', function() {
            const form = document.getElementById('recoverAccountForm');
            if (form.checkValidity()) {
                const btn = this;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang khôi phục...';
                btn.disabled = true;
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-undo me-2"></i>Khôi phục tài khoản';
                    btn.disabled = false;
                    bootstrap.Modal.getInstance(document.getElementById('recoverAccountModal')).hide();
                    alert('Tài khoản đã được khôi phục thành công!');
                    form.reset();
                }, 2000);
            } else {
                form.reportValidity();
            }
        });

        // Account Lock functionality
        function lockUserAccount(userName, userEmail, currentStatus) {
            document.getElementById('lockUser').value = userName;
            document.getElementById('lockEmail').value = userEmail;
            document.getElementById('currentLockStatus').value = getStatusText(currentStatus);
            
            const modal = new bootstrap.Modal(document.getElementById('lockAccountModal'));
            modal.show();
        }

        document.getElementById('confirmLockAccount').addEventListener('click', function() {
            const form = document.getElementById('lockAccountForm');
            if (form.checkValidity()) {
                const btn = this;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang khóa...';
                btn.disabled = true;
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-lock me-2"></i>Khóa tài khoản';
                    btn.disabled = false;
                    bootstrap.Modal.getInstance(document.getElementById('lockAccountModal')).hide();
                    alert('Tài khoản đã được khóa thành công!');
                    form.reset();
                }, 2000);
            } else {
                form.reportValidity();
            }
        });

        function getStatusText(status) {
            const statusLower = String(status).toLowerCase();
            // Handle database values: 1 = active, 0 = blocked
            if (statusLower === '1') return 'Hoạt động';
            if (statusLower === '0') return 'Bị khóa';
            const statusMap = {
                'active': 'Hoạt động',
                'inactive': 'Bị khóa',
                'locked': 'Bị khóa',
                'pending': 'Chờ duyệt'
            };
            return statusMap[statusLower] || status;
        }

        // Enhanced search and filter functionality
        async function filterUsers() {
            const btn = document.querySelector('.btn-filter');
            const originalHtml = btn.innerHTML;
            
            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang lọc...';
                
                // Get filter values - find the selects by their position in the filter-row
                const selects = document.querySelectorAll('.filter-row .form-select');
                const textInputs = document.querySelectorAll('.filter-row .form-control[type="text"]');
                const dateInputs = document.querySelectorAll('.filter-row .form-control[type="date"]');
                
                const keyword = textInputs[0]?.value || '';
                const role = selects[0]?.value || '';
                const status = selects[1]?.value || '';
                const createdAt = dateInputs[0]?.value || '';
                
                console.log('Filter values:', { keyword, role, status, createdAt });
                
                // Fetch filtered data from backend
                let users = allUsers;
                
                // Apply client-side filtering
                filteredUsers = users.filter(user => {
                    // Using DTO with consistent property names
                    const isCustomer = user.userType === 'customer';
                    const userName = (user.fullName || '').toLowerCase();
                    const userEmail = (user.email || '').toLowerCase();
                    const userPhone = (user.phone || '').toLowerCase();
                    const userRole = (user.roleName || '').toLowerCase();
                    const userStatus = (user.status || 'Active').toLowerCase();
                    
                    // Search filter
                    let matchesSearch = true;
                    if (keyword && keyword.trim()) {
                        const searchTerm = keyword.toLowerCase();
                        matchesSearch = userName.includes(searchTerm) || 
                                       userEmail.includes(searchTerm) || 
                                       userPhone.includes(searchTerm);
                    }
                    
                    // Role filter
                    let matchesRole = true;
                    if (role && role.trim()) {
                        if (role === 'customer') {
                            matchesRole = isCustomer;
                        } else if (role === 'staff') {
                            matchesRole = !isCustomer && (userRole.includes('staff') || userRole.includes('nhân viên'));
                        } else if (role === 'admin') {
                            matchesRole = !isCustomer && (userRole.includes('admin') || userRole.includes('quản trị'));
                        }
                    }
                    
                    // Status filter
                    let matchesStatus = true;
                    if (status && status.trim()) {
                        if (status === 'active') {
                            matchesStatus = userStatus === '1' || userStatus === 'active' || userStatus.includes('hoạt động');
                        } else if (status === 'inactive') {
                            matchesStatus = userStatus === '0' || userStatus === 'inactive' || userStatus.includes('không hoạt động');
                        } else if (status === 'pending') {
                            matchesStatus = userStatus === 'pending' || userStatus.includes('chờ duyệt');
                        }
                    }
                    
                    // Date filter
                    let matchesDate = true;
                    if (createdAt && createdAt.trim()) {
                        if (user.createdAt) {
                            const userDate = new Date(user.createdAt);
                            const filterDate = new Date(createdAt);
                            
                            // Compare only the date part (ignore time)
                            userDate.setHours(0, 0, 0, 0);
                            filterDate.setHours(0, 0, 0, 0);
                            
                            matchesDate = userDate.getTime() === filterDate.getTime();
                        } else {
                            matchesDate = false;
                        }
                    }
                    
                    return matchesSearch && matchesRole && matchesStatus && matchesDate;
                });
                
                console.log('Filtered users count:', filteredUsers.length);
                renderUsers(filteredUsers);
                btn.innerHTML = originalHtml;
                
            } catch (error) {
                console.error('Error filtering users:', error);
                btn.innerHTML = originalHtml;
            }
        }

        // Auto-search on input and filter changes
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('.filter-row .form-control[type="text"]');
            const roleSelect = document.querySelectorAll('.filter-row .form-select')[0];
            const statusSelect = document.querySelectorAll('.filter-row .form-select')[1];
            const dateInput = document.querySelector('.filter-row .form-control[type="date"]');
            const filterBtn = document.querySelector('.btn-filter');
            
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        filterUsers();
                    }, 500);
                });
            }
            
            // Add event listeners to selects
            if (roleSelect) {
                roleSelect.addEventListener('change', function() {
                    filterUsers();
                });
            }
            
            if (statusSelect) {
                statusSelect.addEventListener('change', function() {
                    filterUsers();
                });
            }
            
            // Add event listener to date input
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    filterUsers();
                });
            }
            
            // Add event listener to filter button
            if (filterBtn) {
                filterBtn.addEventListener('click', function() {
                    filterUsers();
                });
            }
        });

        // Load roles function
        async function loadRoles() {
            try {
                const response = await fetch('/admin/roles');
                const roles = await response.json();
                console.log('Loaded roles:', roles);
                
                // Store roles globally for later use
                window.allRoles = roles;
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }
        
        // Load roles into the select dropdown
        async function loadRolesIntoSelect(roleSelectElement) {
            console.log('=== loadRolesIntoSelect() called ===');
            try {
                console.log('Fetching from /admin/roles...');
                const response = await fetch('/admin/roles');
                
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const roles = await response.json();
                console.log('Received roles data:', roles);
                console.log('Number of roles:', roles.length);
                
                const roleSelect = roleSelectElement || document.getElementById('role');
                console.log('Role select element found:', !!roleSelect);
                
                if (!roleSelect) {
                    console.error('❌ Role select element not found');
                    return;
                }
                
                // Clear existing options except the first one
                roleSelect.innerHTML = '<option value="">Chọn vai trò</option>';
                
                // Add roles from database
                if (!Array.isArray(roles) || roles.length === 0) {
                    console.warn('⚠️ No roles found in response');
                    return;
                }
                
                let addedCount = 0;
                roles.forEach(role => {
                    try {
                        const option = document.createElement('option');
                        // Now using DTO with camelCase properties
                        const roleId = role.roleID;
                        const roleName = role.roleName;
                        
                        console.log('Processing role:', { roleId, roleName, fullRole: role });
                        
                        if (roleId && roleName) {
                            option.value = roleId;
                            option.textContent = roleName;
                            roleSelect.appendChild(option);
                            addedCount++;
                            console.log('✅ Added role:', roleName, 'with ID:', roleId);
                        } else {
                            console.warn('⚠️ Skipping role with missing ID or Name:', role);
                        }
                    } catch (err) {
                        console.error('Error adding role option:', err, role);
                    }
                });
                
                console.log('✅ Successfully populated ' + addedCount + ' roles into select');
            } catch (error) {
                console.error('❌ Error loading roles into select:', error);
                alert('Lỗi khi tải danh sách vai trò: ' + error.message);
            }
        }
        
        // Load users when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadRoles(); // Also load roles
            
            // Load roles when Add User Modal is opened
            const addUserModal = document.getElementById('addUserModal');
            if (addUserModal) {
                console.log('Setting up event listener for Add User Modal');
                addUserModal.addEventListener('show.bs.modal', async function () {
                    console.log('Add User Modal opened - loading roles');
                    await loadRolesIntoSelect();
                });
            } else {
                console.error('Add User Modal not found');
            }
        });
        
        // Save Edit functionality
        document.getElementById('saveEditBtn').addEventListener('click', async function() {
            const btn = this;
            const userId = document.getElementById('editUserId').value;
            
            if (!userId) {
                alert('Không tìm thấy ID người dùng');
                return;
            }
            
            const lastName = document.getElementById('editLastName').value;
            const firstName = document.getElementById('editFirstName').value;
            const fullName = `${lastName} ${firstName}`.trim();
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const roleId = parseInt(document.getElementById('editRole').value);
            const status = document.getElementById('editStatus').value;
            
            if (!fullName || !email || !phone || !roleId) {
                alert('Vui lòng điền đầy đủ thông tin');
                return;
            }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...';
            btn.disabled = true;
            
            try {
                const userData = {
                    fullName: fullName,
                    email: email,
                    phone: phone,
                    roleId: roleId,
                    status: status
                };
                
                console.log('Updating employee:', userId, userData);
                
                const response = await fetch(`/admin/employees/${userId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.text();
                
                if (result === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    document.getElementById('editUserForm').reset();
                    
                    alert('Đã cập nhật thông tin nhân viên thành công!');
                    
                    // Reload users list
                    await loadUsers();
                } else {
                    alert('Lỗi: ' + result);
                }
                
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Có lỗi xảy ra khi cập nhật thông tin: ' + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-save me-2"></i>Lưu thay đổi';
                btn.disabled = false;
            }
        });

        // Helper functions for user actions
        async function editUser(userId, isCustomer) {
            console.log('=== editUser called ===');
            console.log('userId:', userId, 'type:', typeof userId);
            console.log('isCustomer:', isCustomer);
            console.log('allUsers:', allUsers);
            
            // Find user data
            const user = allUsers.find(u => u.id === parseInt(userId));
            console.log('Found user:', user);
            
            if (!user) {
                alert('Không tìm thấy thông tin người dùng trong danh sách');
                return;
            }
            
            // Only employees can be edited via this modal
            if (user.userType !== 'employee') {
                alert('Chức năng chỉnh sửa chỉ áp dụng cho nhân viên');
                return;
            }
            
            // Load employee details - userId here is from UserDTO (user.id)
            // We need to map it to the correct employee
            try {
                const response = await fetch(`/admin/employees/list`);
                const employees = await response.json();
                console.log('All employees:', employees);
                console.log('Looking for user with ID:', userId);
                
                // Now using EmployeeDTO with consistent naming
                let employee = employees.find(e => e.userID === parseInt(userId));
                
                // If not found by ID, try by email
                if (!employee && user.email) {
                    console.log('Searching by email:', user.email);
                    employee = employees.find(e => e.email === user.email);
                }
                
                if (!employee) {
                    console.error('Employee not found. userId:', userId, 'user:', user, 'employees:', employees);
                    alert('Không tìm thấy thông tin nhân viên');
                    return;
                }
                
                console.log('Found employee:', employee);
                
                // Set user ID
                document.getElementById('editUserId').value = employee.userID;
                
                // Get values from EmployeeDTO
                const fullName = employee.fullName || '';
                const email = employee.email || '';
                const phone = employee.phone || '';
                
                // Split full name into first and last name
                const nameParts = fullName.split(' ');
                const lastName = nameParts[0] || '';
                const firstName = nameParts.slice(1).join(' ') || '';
                
                // Fill form fields
                document.getElementById('editLastName').value = lastName;
                document.getElementById('editFirstName').value = firstName;
                document.getElementById('editEmail').value = email;
                document.getElementById('editPhone').value = phone;
                
                // Load and select role
                await loadRolesIntoSelect(document.getElementById('editRole'));
                const roleId = employee.roleID;
                if (roleId) {
                    document.getElementById('editRole').value = roleId;
                }
                
                // Set status
                const statusValue = employee.status === '1' || employee.status === 'Active' ? '1' : '0';
                document.getElementById('editStatus').value = statusValue;
                
                // Open modal
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading employee data:', error);
                alert('Có lỗi xảy ra khi tải thông tin nhân viên');
            }
        }

        async function lockEmployeeAccount(employeeId) {
            if (confirm('Bạn có chắc chắn muốn khóa tài khoản nhân viên này?')) {
                try {
                    // Send "0" for locked/inactive status
                    const response = await fetch(`/admin/employees/${employeeId}/status?status=0`, {
                        method: 'POST'
                    });
                    
                    const result = await response.text();
                    if (result === 'success') {
                        alert('Đã khóa tài khoản thành công!');
                        await loadUsers(); // Reload main user list
                        // Note: The locked accounts list will refresh when the recover modal is opened
                    } else {
                        alert('Lỗi: ' + result);
                    }
                } catch (error) {
                    console.error('Error locking account:', error);
                    alert('Có lỗi xảy ra khi khóa tài khoản');
                }
            }
        }

        async function recoverCustomerAccount(customerId) {
            if (confirm('Bạn có chắc chắn muốn khôi phục tài khoản khách hàng này?')) {
                try {
                    const response = await fetch(`/admin/customers/${customerId}/recover`, {
                        method: 'POST'
                    });
                    
                    const result = await response.text();
                    if (result === 'success') {
                        alert('Đã khôi phục tài khoản thành công!');
                        await loadUsers();
                    } else {
                        alert('Lỗi: ' + result);
                    }
                } catch (error) {
                    console.error('Error recovering account:', error);
                    alert('Có lỗi xảy ra khi khôi phục tài khoản');
                }
            }
        }

        // Account recovery functionality
        document.querySelectorAll('.btn-success').forEach(btn => {
            if (btn.textContent.includes('Khôi phục')) {
                btn.addEventListener('click', function() {
                    if (confirm('Bạn có chắc chắn muốn khôi phục tài khoản này?')) {
                        console.log('Account recovery initiated');
                        // Simulate recovery process
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang khôi phục...';
                        this.disabled = true;
                        setTimeout(() => {
                            this.innerHTML = '<i class="fas fa-check"></i> Đã khôi phục';
                            this.classList.remove('btn-success');
                            this.classList.add('btn-outline-success');
                        }, 2000);
                    }
                });
            }
        });

        // Reset password functionality
        document.querySelectorAll('.btn-warning').forEach(btn => {
            if (btn.textContent.includes('Reset mật khẩu')) {
                btn.addEventListener('click', function() {
                    const userInput = document.querySelector('#resetPasswordModal input[type="text"]').value;
                    if (!userInput) {
                        alert('Vui lòng nhập email hoặc số điện thoại người dùng');
                        return;
                    }
                    
                    if (confirm('Bạn có chắc chắn muốn reset mật khẩu cho người dùng này?')) {
                        console.log('Password reset initiated for:', userInput);
                        // Simulate reset process
                        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang reset...';
                        this.disabled = true;
                        setTimeout(() => {
                            this.innerHTML = '<i class="fas fa-check me-2"></i>Đã reset';
                            this.classList.remove('btn-warning');
                            this.classList.add('btn-success');
                            alert('Mật khẩu đã được reset và gửi đến người dùng!');
                        }, 2000);
                    }
                });
            }
        });

        // Load deleted accounts when recover modal is opened
        const recoverAccountModal = document.getElementById('recoverAccountModal');
        if (recoverAccountModal) {
            recoverAccountModal.addEventListener('show.bs.modal', async function () {
                await loadLockedAccounts();
            });
        }

        // Load locked accounts (customers + employees)
        async function loadLockedAccounts() {
            try {
                const response = await fetch('/admin/users/locked');
                const lockedAccounts = await response.json();
                
                const tbody = document.getElementById('deletedAccountsBody');
                tbody.innerHTML = '';
                
                if (lockedAccounts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Không có tài khoản nào đã bị khóa</td></tr>';
                    return;
                }
                
                lockedAccounts.forEach(account => {
                    const tr = document.createElement('tr');
                    const initials = account.fullName ? account.fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'NA';
                    const userTypeText = account.userType === 'employee' ? 'Nhân viên' : 'Khách hàng';
                    // Check if status is "0" (locked) or "Deleted" (for soft-deleted customers)
                    const isLocked = account.status === '0' || account.status === 'Inactive' || account.status === 'Deleted';
                    const statusBadge = isLocked
                        ? '<span class="badge bg-danger">Đã khóa</span>' 
                        : '<span class="badge bg-secondary">' + account.status + '</span>';
                    
                    tr.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar-sm me-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">${initials}</div>
                                <div>
                                    <div class="fw-bold">${account.fullName || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${account.email || 'N/A'}</td>
                        <td>${userTypeText}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="recoverAccount('${account.userType}', ${account.id}, '${account.fullName || 'tài khoản'}')">
                                <i class="fas fa-undo"></i> Khôi phục
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading locked accounts:', error);
                document.getElementById('deletedAccountsBody').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>';
            }
        }

        // Recover account function (for both customers and employees)
        window.recoverAccount = async function(userType, accountId, accountName) {
            if (confirm(`Bạn có chắc chắn muốn khôi phục tài khoản của ${accountName}?`)) {
                try {
                    let apiEndpoint;
                    if (userType === 'employee') {
                        apiEndpoint = `/admin/employees/${accountId}/recover`;
                    } else {
                        apiEndpoint = `/admin/customers/${accountId}/recover`;
                    }
                    
                    const response = await fetch(apiEndpoint, {
                        method: 'POST'
                    });
                    
                    const result = await response.text();
                    if (result === 'success') {
                        alert('Đã khôi phục tài khoản thành công!');
                        await loadLockedAccounts(); // Reload the locked accounts list
                        await loadUsers(); // Reload main user list
                    } else {
                        alert('Lỗi: ' + result);
                    }
                } catch (error) {
                    console.error('Error recovering account:', error);
                    alert('Có lỗi xảy ra khi khôi phục tài khoản');
                }
            }
        };
    </script>
</body>
</html>
